name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v3.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.ref_name || inputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.TAG }}
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    needs: goreleaser
    runs-on: ubuntu-latest
    env:
      TAG: ${{ github.ref_name || inputs.tag }}
    steps:
      - name: Download checksums from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "${{ env.TAG }}" --repo ${{ github.repository }} --pattern "checksums.txt"
          cat checksums.txt

      - name: Parse checksums
        id: checksums
        run: |
          VERSION="${{ env.TAG }}"
          VERSION_NUM="${VERSION#v}"

          # GoReleaser checksums.txt format: <hash>  <filename>
          DARWIN_ARM64_SHA=$(grep "darwin_arm64.tar.gz" checksums.txt | cut -d' ' -f1)
          DARWIN_AMD64_SHA=$(grep "darwin_amd64.tar.gz" checksums.txt | cut -d' ' -f1)
          LINUX_ARM64_SHA=$(grep "linux_arm64.tar.gz" checksums.txt | cut -d' ' -f1)
          LINUX_AMD64_SHA=$(grep "linux_amd64.tar.gz" checksums.txt | cut -d' ' -f1)

          echo "version=${VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "darwin_arm64_sha=${DARWIN_ARM64_SHA}" >> $GITHUB_OUTPUT
          echo "darwin_amd64_sha=${DARWIN_AMD64_SHA}" >> $GITHUB_OUTPUT
          echo "linux_arm64_sha=${LINUX_ARM64_SHA}" >> $GITHUB_OUTPUT
          echo "linux_amd64_sha=${LINUX_AMD64_SHA}" >> $GITHUB_OUTPUT

      # TAP_GITHUB_TOKEN (a PAT) is required to push to the open-cli-collective/homebrew-tap
      # repository. The default GITHUB_TOKEN only has access to this repository.
      - name: Update Homebrew Cask
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.checksums.outputs.version }}"
          DARWIN_ARM64_SHA="${{ steps.checksums.outputs.darwin_arm64_sha }}"
          DARWIN_AMD64_SHA="${{ steps.checksums.outputs.darwin_amd64_sha }}"
          LINUX_ARM64_SHA="${{ steps.checksums.outputs.linux_arm64_sha }}"
          LINUX_AMD64_SHA="${{ steps.checksums.outputs.linux_amd64_sha }}"

          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/open-cli-collective/homebrew-tap.git
          cd homebrew-tap

          mkdir -p Casks

          cat > Casks/slack-chat-api.rb << CASKEOF
          cask "slack-chat-api" do
            name "slack-chat-api"
            desc "Command-line interface for Slack"
            homepage "https://github.com/open-cli-collective/slack-chat-api"
            version "${VERSION}"

            binary "slack-chat-api"

            on_macos do
              on_arm do
                url "https://github.com/open-cli-collective/slack-chat-api/releases/download/v#{version}/slack-chat-api_v#{version}_darwin_arm64.tar.gz"
                sha256 "${DARWIN_ARM64_SHA}"
              end
              on_intel do
                url "https://github.com/open-cli-collective/slack-chat-api/releases/download/v#{version}/slack-chat-api_v#{version}_darwin_amd64.tar.gz"
                sha256 "${DARWIN_AMD64_SHA}"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/open-cli-collective/slack-chat-api/releases/download/v#{version}/slack-chat-api_v#{version}_linux_arm64.tar.gz"
                sha256 "${LINUX_ARM64_SHA}"
              end
              on_intel do
                url "https://github.com/open-cli-collective/slack-chat-api/releases/download/v#{version}/slack-chat-api_v#{version}_linux_amd64.tar.gz"
                sha256 "${LINUX_AMD64_SHA}"
              end
            end

            postflight do
              system_command "/usr/bin/xattr", args: ["-dr", "com.apple.quarantine", "#{staged_path}/slack-chat-api"]
            end

            caveats <<~EOS
              To configure slack-chat-api, run:
                slack-chat-api config set-token

              On macOS, your token is stored securely in the system Keychain.
              On Linux, your token is stored in ~/.config/slack-chat-api/credentials.
            EOS
          end
          CASKEOF

          # Remove old formula if it exists
          rm -f Formula/slack-chat-api.rb

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update slack-chat-api to ${VERSION}"
          git push
